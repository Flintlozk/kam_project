<reactor-room-loader block="true" [text]="isOnSendingImageText" *ngIf="isOnSendingImage"></reactor-room-loader>
<section [ngClass]="{ 'line-template': audience?.platform === EAudiencePlatformType.LINEOA }" (paste)="pasteClipboard($event)" *ngIf="audience">
  <div class="relative shadow-md chat-box" [ngClass]="{ 'extra-grid': extraGrid, collapse: chatBoxStatus, 'view-mode-history': viewMode === viewEnum.HISTORY }">
    <div *ngIf="viewMode === viewEnum.ORDER || viewMode === viewEnum.AUDIENCE || enableHead" class="relative bg-white shadow-md head z-2">
      <div class="left-content">
        <!-- <img [src]="audience.profile_pic" alt="" /> -->
        <div class="relative cursor-pointer profile" (click)="goToCustomerInfo()">
          <img [src]="audience.profile_pic" class="image" onerror="src='assets/img/customer/customer_error.svg'" />
          <svg
            *ngIf="audience?.platform !== EAudiencePlatformType.LINEOA"
            class="absolute bottom-0 right-0 z-10"
            width="16"
            height="16"
            viewBox="0 0 16 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path d="M8 16C12.4183 16 16 12.4183 16 8C16 3.58172 12.4183 0 8 0C3.58172 0 0 3.58172 0 8C0 12.4183 3.58172 16 8 16Z" fill="#0075FB" />
            <path
              d="M9.84372 4.39307H10.8475V2.67584C10.6743 2.65244 10.0787 2.59979 9.38511 2.59979C6.20919 2.59979 7.07327 6.13236 6.94682 6.64987H5.34924V8.5696H6.94636V13.4H8.9045V8.57005H10.437L10.6803 6.65032H8.90405C8.99018 5.37949 8.55539 4.39307 9.84372 4.39307Z"
              fill="white"
            />
          </svg>
          <svg
            *ngIf="audience?.platform === EAudiencePlatformType.LINEOA"
            class="absolute bottom-0 right-0 z-10"
            width="16"
            height="16"
            viewBox="0 0 16 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path d="M8 16C12.4183 16 16 12.4183 16 8C16 3.58172 12.4183 0 8 0C3.58172 0 0 3.58172 0 8C0 12.4183 3.58172 16 8 16Z" fill="#00B900" />
            <path
              d="M8.00001 3.79102C5.28272 3.79102 3.07068 5.59195 3.07068 7.80524C3.07068 9.78758 4.8247 11.4485 7.19284 11.7642C7.35345 11.7982 7.57198 11.8706 7.62744 12.0074C7.67673 12.1315 7.65989 12.3231 7.64305 12.4525L7.57568 12.8727C7.5572 12.9967 7.47709 13.3612 8.00659 13.1384C8.5369 12.9165 10.8475 11.4579 11.8827 10.2642C12.5909 9.48619 12.9294 8.68892 12.9294 7.80524C12.9294 5.59195 10.7173 3.79102 8.00001 3.79102ZM6.07059 9.12134H5.09047C4.94876 9.12134 4.83168 9.00381 4.83168 8.86213V6.89617C4.83168 6.75408 4.94876 6.63656 5.09047 6.63656C5.23342 6.63656 5.34926 6.75408 5.34926 6.89617V8.60251H6.07059C6.21354 8.60251 6.32897 8.71922 6.32897 8.86213C6.32897 9.00381 6.21313 9.12134 6.07059 9.12134ZM7.08357 8.86213C7.08357 9.00381 6.96773 9.12134 6.82437 9.12134C6.68265 9.12134 6.56681 9.00381 6.56681 8.86213V6.89617C6.56681 6.75408 6.68265 6.63656 6.8256 6.63656C6.96773 6.63656 7.08357 6.75408 7.08357 6.89617V8.86213ZM9.44185 8.86213C9.44185 8.97351 9.37037 9.0722 9.26439 9.10782C9.2381 9.11642 9.20976 9.12052 9.18264 9.12052C9.09597 9.12052 9.02203 9.08325 8.97315 9.01733L7.96962 7.65045V8.86172C7.96962 9.0034 7.85501 9.12093 7.71042 9.12093C7.56829 9.12093 7.45327 9.0034 7.45327 8.86172V6.89617C7.45327 6.78479 7.52433 6.6861 7.6299 6.65089C7.65455 6.64147 7.68577 6.63738 7.70959 6.63738C7.7897 6.63738 7.86364 6.68037 7.91293 6.7422L8.92427 8.1144V6.89617C8.92427 6.75408 9.0401 6.63656 9.18306 6.63656C9.32477 6.63656 9.44185 6.75408 9.44185 6.89617V8.86213ZM11.0254 7.61933C11.1688 7.61933 11.2842 7.73685 11.2842 7.87936C11.2842 8.02145 11.1688 8.13897 11.0254 8.13897H10.3045V8.60251H11.0254C11.1688 8.60251 11.2842 8.71922 11.2842 8.86213C11.2842 9.00381 11.1688 9.12134 11.0254 9.12134H10.0453C9.90356 9.12134 9.78772 9.00381 9.78772 8.86213V6.89617C9.78772 6.75408 9.90356 6.63656 10.0465 6.63656H11.0266C11.1688 6.63656 11.2842 6.75408 11.2842 6.89617C11.2842 7.0399 11.1688 7.15579 11.0254 7.15579H10.3045V7.61933H11.0254Z"
              fill="white"
            />
          </svg>
        </div>
        <div class="txt">
          <span
            *ngIf="audience?.platform === EAudiencePlatformType.LINEOA"
            [matTooltipShowDelay]="1000"
            [matTooltip]="audience.first_name + ' ' + (audience.aliases !== null ? audience.aliases : '')"
            >{{ audience.first_name + ' ' + (audience.aliases !== null ? audience.aliases : '') | textTrim: 35 }}</span
          >
          <span
            *ngIf="audience?.platform === EAudiencePlatformType.FACEBOOKFANPAGE"
            [matTooltipShowDelay]="1000"
            [matTooltip]="audience.first_name + ' ' + (audience.last_name !== null ? audience.last_name : '') + ' ' + (audience.aliases !== null ? audience.aliases : '')"
          >
            {{
              audience.first_name + ' ' + (audience.last_name !== null ? audience.last_name : '') + ' ' + (audience.aliases !== null ? audience.aliases : '') | textTrim: 35
            }}</span
          >
          <div class="flex profile-name" *ngIf="tagsAttached?.length > 0" [@slideInOut]>
            <div [matTooltip]="tag.name" *ngFor="let tag of tagsAttached; index as tagIndex">
              <div *ngIf="tagIndex <= 2">
                <div class="tag-color" [ngStyle]="{ background: customerTagEnum[tag.color] }"></div>
              </div>
            </div>
            <div *ngIf="tagsAttached?.length - 3 > 0">
              <div class="flex">{{ tagsAttached?.length - 3 }}+ {{ 'Tags' | translate }}</div>
            </div>
          </div>

          <div class="flex referral" *ngIf="audience.referral !== null" (mouseover)="bReferral = true" (mouseout)="bReferral = false">
            {{ 'Ref' | translate }} : {{ audience.referral?.source | translate }}

            <div class="referral-detail" *ngIf="audience.referral?.source !== 'UNKNOWN'">
              <ng-container *ngIf="audience.referral.source === 'SHORTLINK'">
                <span>{{ 'Ref ID' | translate }} : {{ audience.referral?.ref }} </span>
              </ng-container>
              <ng-container *ngIf="audience.referral.source === 'ADS'">
                <span>{{ 'Ref ID' | translate }} : {{ audience.referral?.ref }} </span>
                <span *ngIf="audience.referral?.ad_id !== null">{{ 'ID' | translate }} : {{ audience.referral?.ad_id }}</span>
                <span *ngIf="audience.referral?.ads_context_data !== null">{{ 'Ad title' | translate }} : {{ audience.referral?.ads_context_data?.ad_title | textTrim: 25 }}</span>
              </ng-container>
              <ng-container *ngIf="audience.referral?.source === 'CUSTOMER_CHAT_PLUGIN'">
                <span>{{ 'Ref ID' | translate }} : {{ audience.referral?.ref }}</span>
                <span> URL : {{ audience.referral?.referer_uri }}</span>
              </ng-container>
            </div>
          </div>
          <ng-container [ngSwitch]="viewMode">
            <!-- <div *ngSwitchCase="viewEnum.ORDER" class="order-info">
            <span>{{ 'Order No' | translate }}.</span> {{ orderId | orderId }}
          </div> -->
          </ng-container>
        </div>
      </div>

      <div class="flex text-sm right-content">
        <div class="flex flex-col text-gray-400 history-txt">
          <span *ngIf="updatedBy?.name" class="text-right"> {{ 'Updated by' | translate }} {{ updatedBy?.name }} </span>
          <span *ngIf="updatedBy?.created_at" class="text-right"> {{ updatedBy?.created_at | timeAgo: 'utc' }} </span>
        </div>

        <ng-container>
          <div [matTooltip]="'History' | translate" class="flex items-center ml-15 cursor-pointer text-blue hover:text-blue-dark" (click)="showHistoryDetails(audienceId)">
            <svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M9.72533 5.13824L9.72351 9.76747C9.72351 9.94323 9.78955 10.1112 9.90702 10.2353L13.0418 13.5463L13.9275 12.6106L10.9762 9.49346L10.978 5.13824H9.72533Z" />
              <path
                d="M10.8037 0C6.18001 0 2.35331 3.40115 1.71241 7.80747H5.50516e-05L2.38076 10.628L4.76043 7.80747H3.03983C3.66827 4.12087 6.90551 1.30126 10.8037 1.30126C15.1504 1.30126 18.6863 4.80342 18.6863 9.10873C18.6863 13.414 15.1504 16.9162 10.8037 16.9162C8.36032 16.9162 6.09462 15.8208 4.58774 13.9109L3.5524 14.7114C5.31004 16.939 7.95295 18.2174 10.8037 18.2174C15.8746 18.2174 20 14.1307 20 9.10873C20 4.08676 15.8746 0 10.8037 0Z"
              />
            </svg>
            <!-- <div class="ml-5">
              {{ 'History' | translate }}
            </div> -->
          </div>

          <div
            *ngIf="audience.latest_sent_by === 'AUDIENCE'"
            [matTooltip]="'Mark as Unread' | translate"
            class="flex items-center ml-15 cursor-pointer text-blue hover:text-blue-dark"
            (click)="setChatUnread(audienceId)"
          >
            <svg width="20" height="20" viewBox="0 0 272 272" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
              <!-- Generator: Sketch 61 (89581) - https://sketch.com -->
              <title>Artboard</title>
              <desc>Created with Sketch.</desc>
              <g id="Artboard" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                <g
                  id="Group"
                  transform="translate(11.000000, 17.000000)"
                  stroke="#53B1FF"
                  stroke-width="14"
                  [ngStyle]="{ stroke: audience?.platform === EAudiencePlatformType.FACEBOOKFANPAGE ? '#53B1FF' : '#FFF' }"
                >
                  <path
                    d="M229,27 C241.150264,27 251,36.8497355 251,49 L251,178 C251,190.150264 241.150264,200 229,200 L111.9,200 L103.037699,209.461588 L78.1086659,236.073781 C76.7852335,237.486569 74.9358313,238.288226 73,238.288226 C69.1340068,238.288226 66,235.154219 66,231.288226 L66,231.288226 L65.999,200 L22,200 C9.8497355,200 1.5698833e-14,190.150264 0,178 L0,49 C-1.48797825e-15,36.8497355 9.8497355,27 22,27 L229,27 Z"
                    id="Combined-Shape"
                  ></path>
                  <line x1="17" y1="0" x2="243" y2="227" id="Line-13" stroke-linecap="round"></line>
                </g>
              </g>
            </svg>
          </div>

          <button id="chatbox-mobile-back-button" class="back" (click)="onBack()">
            <svg width="24" height="44" viewBox="0 0 24 44" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M1.46416 20.8475L20.3055 1.47495C20.9228 0.840605 21.9223 0.841671 22.5386 1.47823C23.1544 2.11471 23.1528 3.14576 22.5354 3.78059L4.81552 22.0001L22.536 40.2195C23.1533 40.8544 23.1549 41.8848 22.5392 42.5214C22.2303 42.8405 21.8255 43 21.4208 43C21.0171 43 20.614 42.8415 20.3056 42.5246L1.46416 23.1526C1.16684 22.8476 1 22.4325 1 22.0001C1 21.5676 1.16732 21.153 1.46416 20.8475Z"
                fill="#89A5BB"
                stroke="#89A5BB"
                stroke-width="2"
              />
            </svg>
          </button>
          <button class="action" (click)="activeButtonGroup()">
            <svg width="21" height="21" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="2.5" cy="10.5" r="2.5" fill="#53B1FF" />
              <circle cx="10.5" cy="10.5" r="2.5" fill="#53B1FF" />
              <circle cx="18.5" cy="10.5" r="2.5" fill="#53B1FF" />
            </svg>
          </button>
        </ng-container>
      </div>
    </div>

    <!-- MESSAGE SECTION -->
    <div class="content" *ngIf="!messages$">
      <div class="chat-content">
        {{ 'Loading' | translate }}
      </div>
    </div>
    <div
      id="chat-content-wrapper"
      class="content"
      (scroll)="listScrolling($event)"
      *ngIf="messages$ | async as messages"
      #content
      [ngClass]="{ 'extra-grid': !extraGrid, 'view-mode-history': viewMode === viewEnum.HISTORY }"
    >
      <div *ngIf="isLoading" class="message-loader" [@fadeInOutFastest]></div>
      <div *ngIf="audience.status === 'COMMENT' && commentCover" class="comment-cover" [@fadeInOutFastest]>
        <div class="comment-cover-dismiss" (click)="commentCover = false">
          <div class="dismiss-button">X</div>
        </div>
        <div class="comment-cover-content">
          <div class="comment-cover-text">
            <div>
              {{ 'The audience has commented on a post' | translate }}
            </div>
            <div class="view-comment" (click)="viewComment()">
              {{ 'View post' | translate }}
            </div>
          </div>
        </div>
      </div>
      <reactor-room-previous-messages *ngIf="!isLastRecord" [isRequesting]="isRequesting" (previousMessages)="addPreviousMessages()"></reactor-room-previous-messages>

      <!-- MESSAGE LOOP GOES HERE -->
      <ng-container *ngFor="let message of messages; let messageIndex = index; let first = first; let last = last; trackBy: chatboxConfig.trackById">
        <!-- ? Date on first message of day -->
        <div class="date" *ngIf="message | chatDisplayDate: messages[messageIndex - 1]:isLastRecord">
          {{ message.createdAt | todayYesterdayDate | translate }}
        </div>

        <!-- MESSAGE WRAPPER -->
        <div
          class="message"
          [ngClass]="{
            left: message.sentBy === sender.AUDIENCE,
            right: message.sentBy !== sender.AUDIENCE,
            'sent-by': message.sentBy === 'PAGE' && messages[messageIndex + 1]?.sender?.user_id !== message?.sender?.user_id && message?.sender?.user_id,
            'sent-by-line': messages[messageIndex + 1]?.sender?.line_user_id !== message?.sender?.line_user_id && (message?.sender?.group_id || message?.sender?.room_id)
          }"
        >
          <!-- ? Message Container  -->
          <div
            class="flex flex-col justify-center chat-content"
            [ngClass]="{
              'in-scope':
                (messages[messageIndex + 1]?.sender?.user_id !== message?.sender?.user_id && message?.sender?.user_id) ||
                messages[messageIndex + 1]?.sender?.line_user_id !== message?.sender?.line_user_id,
              left: message.sentBy === sender.AUDIENCE,
              right: message.sentBy === sender.PAGE,
              loading: message.sentBy === sender.APP,
              last: last
            }"
          >
            <div>
              <!-- ? ... for more action -->
              <button
                mat-icon-button
                [matMenuTriggerFor]="menu"
                class="absolute top-0 invisible border-none cursor-pointer more-actions -left-30 transparent"
                [matTooltip]="'More actions' | translate"
                [ngClass]="{ '-right-30': message.sentBy === sender.AUDIENCE, '-left-30': message.sentBy === sender.PAGE }"
              >
                <svg width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    fill-rule="evenodd"
                    clip-rule="evenodd"
                    d="M5 8.5C5 9.32843 4.32843 10 3.5 10C2.67157 10 2 9.32843 2 8.5C2 7.67157 2.67157 7 3.5 7C4.32843 7 5 7.67157 5 8.5ZM10 8.5C10 9.32843 9.32843 10 8.5 10C7.67157 10 7 9.32843 7 8.5C7 7.67157 7.67157 7 8.5 7C9.32843 7 10 7.67157 10 8.5ZM13.5 10C14.3284 10 15 9.32843 15 8.5C15 7.67157 14.3284 7 13.5 7C12.6716 7 12 7.67157 12 8.5C12 9.32843 12.6716 10 13.5 10Z"
                    fill="#C4C4C4"
                  />
                </svg>
              </button>
              <mat-menu class="more-menu" #menu="matMenu" [xPosition]="message.sentBy === sender.AUDIENCE ? 'after' : 'before'">
                <div class="py-5 item">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      fill-rule="evenodd"
                      clip-rule="evenodd"
                      d="M5 0.25C3.48122 0.25 2.25 1.48122 2.25 3H3.75C3.75 2.30964 4.30964 1.75 5 1.75H17C17.6904 1.75 18.25 2.30964 18.25 3V15C18.25 15.6904 17.6904 16.25 17 16.25V17.75C18.5188 17.75 19.75 16.5188 19.75 15V3C19.75 1.48122 18.5188 0.25 17 0.25H5ZM2 5.5H14C14.2761 5.5 14.5 5.72386 14.5 6V18C14.5 18.2761 14.2761 18.5 14 18.5H2C1.72386 18.5 1.5 18.2761 1.5 18V6C1.5 5.72386 1.72386 5.5 2 5.5ZM0 6C0 4.89543 0.895431 4 2 4H14C15.1046 4 16 4.89543 16 6V18C16 19.1046 15.1046 20 14 20H2C0.895431 20 0 19.1046 0 18V6Z"
                      fill="#53B1FF"
                    />
                  </svg>
                  <div class="ml-10">
                    {{ 'Copy' | translate }}
                  </div>
                </div>
                <div class="py-5 item" (click)="openCalendar.emit(message)">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      fill-rule="evenodd"
                      clip-rule="evenodd"
                      d="M5.625 3.75C5.28 3.75 5 3.54 5 3.28125V2.49189H2.29172C1.71753 2.49189 1.25 2.95623 1.25 3.52669V6.25H18.75V3.52669C18.75 2.95623 18.2825 2.49189 17.7083 2.49189H15V3.28125C15 3.54 14.72 3.75 14.375 3.75C14.03 3.75 13.75 3.54 13.75 3.28125V2.49189H6.25V3.28125C6.25 3.54 5.97 3.75 5.625 3.75ZM13.75 1.25H6.25V0.46875C6.25 0.209999 5.97 0 5.625 0C5.28 0 5 0.209999 5 0.46875V1.25H2.29172C1.02753 1.25 0 2.27071 0 3.52669V6.875V17.7232C0 18.9791 1.02753 20 2.29172 20H17.7083C18.9725 20 20 18.9791 20 17.7232V6.875V3.52669C20 2.27071 18.9725 1.25 17.7083 1.25H15V0.46875C15 0.209999 14.72 0 14.375 0C14.03 0 13.75 0.209999 13.75 0.46875V1.25ZM1.25 7.5H18.75V17.7232C18.75 18.2936 18.2825 18.7581 17.7083 18.7581H2.29172C1.71753 18.7581 1.25 18.2936 1.25 17.7232V7.5Z"
                      fill="#53B1FF"
                    />
                  </svg>

                  <div class="ml-10">
                    {{ 'Add to Calendar' | translate }}
                  </div>
                </div>
              </mat-menu>

              <div *ngIf="debugMode">
                {{ message | json }}
              </div>

              <!-- ? Message Text -->
              <div class="text" *ngIf="(message.text | script) && message.text; else innerHTMLMode" (click)="copyToClipboard(message.text)">
                {{ message.text }}
              </div>
              <ng-template #innerHTMLMode>
                <div class="text" (click)="copyToClipboard(message.text)" [innerHTML]="message.text | urlify"></div>
              </ng-template>
              <div class="text" *ngIf="!message.text && !message?.attachments">
                <reactor-room-attachment-display [messageID]="message.mid"></reactor-room-attachment-display>
              </div>

              <!-- ? Allure Auto-Message -->
              <div class="text" *ngIf="message?.text === 'template message' && message?.object === 'line' && message?.messagetype === 'text' && message?.sentBy === 'PAGE'">
                <br />
                <ng-container *ngFor="let messagePayload of message?.payload">
                  <!-- TEXT = 'text',   IMAGE = 'image',   LINK = 'link',   BUTTON = 'button' -->
                  <ng-container *ngIf="messagePayload.type === 'text'">
                    <div>{{ messagePayload.text }}</div>
                  </ng-container>
                  <ng-container *ngIf="messagePayload.type === 'image'"></ng-container>
                  <ng-container *ngIf="messagePayload.type === 'link'">
                    <div class="text-center" style="text-align: center">
                      <a style="margin-top: 12px" [href]="messagePayload.text">{{ 'Embedded Link' | translate }}</a>
                    </div>
                  </ng-container>
                  <ng-container *ngIf="messagePayload.type === 'button'"></ng-container>
                </ng-container>
              </div>

              <!-- ? Message Attachments -->
              <reactor-room-chatbox-attachments
                *ngIf="message?.attachments && message?.attachments?.length > 0"
                [audience]="audience"
                [message]="message"
                (imageAttachmentExpiredEvent)="imageAttachmentExpired($event)"
              ></reactor-room-chatbox-attachments>

              <span class="time" [innerText]="message.createdAt | date: 'shortTime'"></span>

              <span *ngIf="message.sentBy === sender.PAGE" class="sent">
                <ng-container *ngIf="message.createdAt | dateToUnix as createdAtUnix">
                  <img
                    *ngIf="latestUserReadTimestamp >= createdAtUnix; else circle"
                    [id]="messageIndex"
                    #readCircle
                    (reactorRoomOnDomChange)="checkReadMessage()"
                    [src]="audience.profile_pic"
                    class="read"
                    [ngClass]="{ append: messageIndex === lastMessageRead }"
                    onerror="src='assets/img/customer/customer_error.svg'"
                  />

                  <ng-template #circle>
                    <svg
                      *ngIf="!latestUserReadTimestamp || latestUserReadTimestamp < createdAtUnix"
                      width="15"
                      height="14"
                      viewBox="0 0 19 18"
                      fill="none"
                      [attr.stroke]="latestAdminSentTimestamp >= createdAtUnix ? 'none' : '#54b1ff'"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <circle cx="9.28601" cy="9" r="9" [attr.fill]="latestAdminSentTimestamp >= createdAtUnix ? '#54b1ff' : 'transparent'" />
                      <path
                        d="M14.9182 4.822C14.6916 4.59058 14.3243 4.59058 14.0977 4.822L7.14643 11.9211L4.47449 9.19237C4.24792 8.96095 3.88058 8.96098 3.65396 9.19237C3.42736 9.42376 3.42736 9.79892 3.65396 10.0303L6.73616 13.178C6.96267 13.4094 7.33028 13.4093 7.5567 13.178L14.9182 5.65999C15.1448 5.4286 15.1448 5.05342 14.9182 4.822Z"
                        [attr.fill]="latestAdminSentTimestamp >= createdAtUnix ? 'white' : '#54b1ff'"
                      />
                    </svg>
                  </ng-template>
                </ng-container>
              </span>
            </div>

            <ng-container *ngIf="message.sentBy === 'PAGE'">
              <div
                class="text-xs space-x-0 sent-by"
                [ngClass]="{ line: audience?.platform === EAudiencePlatformType.LINEOA }"
                *ngIf="messages[messageIndex + 1]?.sender?.user_id !== message?.sender?.user_id && message?.sender?.user_id"
              >
                {{ 'Sent by' | translate }} {{ mapUserSentBy(message?.sender) }}
              </div>
            </ng-container>

            <ng-container *ngIf="message.sentBy === 'AUDIENCE'">
              <div
                class="text-xs sent-by"
                *ngIf="messages[messageIndex + 1]?.sender?.line_user_id !== message?.sender?.line_user_id && (message?.sender?.group_id || message?.sender?.room_id)"
              >
                <div class="line-group">
                  <div class="profile" *ngIf="message?.sender?.picture_url">
                    <img [src]="message?.sender?.picture_url" />
                  </div>
                  <div class="name">{{ message?.sender?.user_name }}</div>
                </div>
              </div>
            </ng-container>
          </div>
        </div>

        <ng-container *ngIf="messages[messageIndex + 1] && messages[messageIndex + 1]?.audienceID !== message?.audienceID">
          <reactor-room-chatbox-audience-seperator
            [previousAudienceID]="messages[messageIndex - 1]?.audienceID"
            [platform]="audience?.platform"
          ></reactor-room-chatbox-audience-seperator>
        </ng-container>

        <ng-container *ngIf="!messages[messageIndex + 1] && audience.status === EAudienceStatusType.CLOSED">
          <reactor-room-chatbox-audience-seperator
            [previousAudienceID]="messages[messageIndex]?.audienceID"
            [platform]="audience?.platform"
          ></reactor-room-chatbox-audience-seperator>
        </ng-container>
      </ng-container>
    </div>

    <div class="absolute bottom-0 left-0 right-0 px-10 suggestions no-scroll-bar animated" [ngClass]="{ show: isSuggestionsShown }">
      <reactor-room-custom-table [isNoVerticalScroll]="true" [tableColSpan]="2" [tableData]="suggestions">
        <tr
          tabindex="0"
          #suggestion
          (click)="selectSuggestion(suggestion)"
          (keyup.ArrowUp)="focusUpSuggestion()"
          (keyup.ArrowDown)="focusDownSuggestion()"
          (keydown.enter)="selectSuggestion(suggestion)"
          *ngFor="let suggestion of suggestions; trackBy: chatboxConfig.trackBy"
          class="cursor-pointer table-content suggestion"
          [class.match-command]="suggestion.isMatchedCommand"
        >
          <td style="white-space: nowrap">
            <ng-container *ngIf="suggestion.text">:{{ suggestion.shortcut }}</ng-container>
            <ng-container *ngIf="suggestion?.images?.length">:/{{ suggestion.shortcut }}</ng-container>
          </td>

          <ng-container *ngIf="suggestion.text">
            <td>
              {{ suggestion.text }}
            </td>
          </ng-container>

          <ng-container *ngIf="suggestion?.images?.length">
            <td style="width: 100%">
              <img class="w-28 h-28 mr-5 rounded-full" height="28" width="28" *ngFor="let image of suggestion?.images" [src]="image | imageExtesnion" />
            </td>
          </ng-container>
        </tr>
      </reactor-room-custom-table>
    </div>

    <ng-container *ngIf="viewMode !== viewEnum.HISTORY">
      <ng-container *ngIf="audience && this.chatController.PRIVATE_ONLY">
        <div class="user-unavailable private">
          <img src="assets/img/audience/warning.svg" alt="Warning" />
          <span
            ><b>Private Message:</b> {{ userUnavailableText }} <u (click)="latestCommentToggleSendPrivateMessage()" style="cursor: pointer"><b>Send Private Message</b></u></span
          >
          <div class="icon-container">
            <div class="more-icon">
              <ng-container *ngIf="!chatBoxStatus">
                <svg (click)="toggleChatBox()" width="37" height="39" viewBox="0 0 47 49" fill="white" stroke="white" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M23.5 2C11.6451 2 2 11.9179 2 24.1082C2 26.8781 2.49531 29.5883 3.47449 32.1685C4.23546 34.1504 5.24352 35.971 6.47741 37.5954L3.54637 44.6621C3.31124 45.2286 3.39671 45.8812 3.76843 46.3636C4.08143 46.77 4.55495 47 5.04805 47C5.14113 47 5.23532 46.9922 5.32891 46.9748L16.4333 44.9822C18.6573 45.8016 21.0321 46.2164 23.5 46.2164C35.355 46.2164 45 36.2984 45 24.1082C45 11.9179 35.355 2 23.5 2Z"
                    fill="#53B1FF"
                    stroke="white"
                    stroke-width="4"
                  />
                  <path
                    d="M23.3688 31.2468L12.7601 20.9697C12.4127 20.633 12.4133 20.0878 12.7619 19.7517C13.1104 19.4158 13.6751 19.4167 14.0227 19.7534L24 29.4188L33.9773 19.7531C34.325 19.4164 34.8893 19.4155 35.2379 19.7513C35.4126 19.9199 35.5 20.1406 35.5 20.3614C35.5 20.5816 35.4132 20.8015 35.2397 20.9697L24.6312 31.2468C24.4642 31.409 24.2369 31.5 24 31.5C23.7632 31.5 23.5362 31.4087 23.3688 31.2468Z"
                    fill="#53B1FF"
                    stroke="white"
                    stroke-width="2"
                  />
                </svg>
              </ng-container>
              <ng-container *ngIf="chatBoxStatus">
                <svg (click)="toggleChatBox()" width="37" height="39" viewBox="0 0 47 49" fill="white" stroke="white" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M23.5 2C11.6451 2 2 11.9179 2 24.1082C2 26.8781 2.49531 29.5883 3.47449 32.1685C4.23546 34.1504 5.24352 35.971 6.47741 37.5954L3.54637 44.6621C3.31124 45.2286 3.39671 45.8812 3.76843 46.3636C4.08143 46.77 4.55495 47 5.04805 47C5.14113 47 5.23532 46.9922 5.32891 46.9748L16.4333 44.9822C18.6573 45.8016 21.0321 46.2164 23.5 46.2164C35.355 46.2164 45 36.2984 45 24.1082C45 11.9179 35.355 2 23.5 2Z"
                    fill="#53B1FF"
                    stroke="white"
                    stroke-width="4"
                  />
                  <path
                    d="M24.6312 17.7532L35.2399 28.0303C35.5873 28.367 35.5867 28.9122 35.2381 29.2483C34.8896 29.5842 34.3249 29.5833 33.9773 29.2466L24 19.5812L14.0227 29.2469C13.675 29.5836 13.1107 29.5845 12.7621 29.2487C12.5874 29.0801 12.5 28.8594 12.5 28.6386C12.5 28.4184 12.5868 28.1985 12.7603 28.0303L23.3688 17.7532C23.5358 17.591 23.7631 17.5 24 17.5C24.2368 17.5 24.4638 17.5913 24.6312 17.7532Z"
                    fill="#53B1FF"
                    stroke="white"
                    stroke-width="2"
                  />
                </svg>
              </ng-container>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- Preview Paste clipboard -->
      <reactor-room-chatbox-clipboard-preview
        *ngIf="isShowPreviewClipboard"
        [pasteClipboard]="pasteClipboardSubject"
        (response)="pasteClipboardResponse($event)"
      ></reactor-room-chatbox-clipboard-preview>

      <ng-container [ngSwitch]="viewMode" *ngIf="audience && !this.chatController.PRIVATE_ONLY">
        <div class="foot" *ngSwitchCase="viewEnum.CLOSED">
          <div class="btns" *ngIf="isMobile">
            <!-- NG_CONTENT: more-icon-->
            <div class="h-full left-btn">
              <!-- <ng-content select=".more-icon"  (click)="toggleChatBox()"></ng-content> -->
              <div class="more-icon" (click)="toggleChatBox()">
                <ng-container *ngIf="!chatBoxStatus">
                  <svg width="47" height="49" viewBox="0 0 47 49" fill="white" stroke="white" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M23.5 2C11.6451 2 2 11.9179 2 24.1082C2 26.8781 2.49531 29.5883 3.47449 32.1685C4.23546 34.1504 5.24352 35.971 6.47741 37.5954L3.54637 44.6621C3.31124 45.2286 3.39671 45.8812 3.76843 46.3636C4.08143 46.77 4.55495 47 5.04805 47C5.14113 47 5.23532 46.9922 5.32891 46.9748L16.4333 44.9822C18.6573 45.8016 21.0321 46.2164 23.5 46.2164C35.355 46.2164 45 36.2984 45 24.1082C45 11.9179 35.355 2 23.5 2Z"
                      fill="#53B1FF"
                      stroke="white"
                      stroke-width="4"
                    />
                    <path
                      d="M23.3688 31.2468L12.7601 20.9697C12.4127 20.633 12.4133 20.0878 12.7619 19.7517C13.1104 19.4158 13.6751 19.4167 14.0227 19.7534L24 29.4188L33.9773 19.7531C34.325 19.4164 34.8893 19.4155 35.2379 19.7513C35.4126 19.9199 35.5 20.1406 35.5 20.3614C35.5 20.5816 35.4132 20.8015 35.2397 20.9697L24.6312 31.2468C24.4642 31.409 24.2369 31.5 24 31.5C23.7632 31.5 23.5362 31.4087 23.3688 31.2468Z"
                      fill="#53B1FF"
                      stroke="white"
                      stroke-width="2"
                    />
                  </svg>
                </ng-container>
                <ng-container *ngIf="chatBoxStatus">
                  <svg width="47" height="49" viewBox="0 0 47 49" fill="white" stroke="white" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M23.5 2C11.6451 2 2 11.9179 2 24.1082C2 26.8781 2.49531 29.5883 3.47449 32.1685C4.23546 34.1504 5.24352 35.971 6.47741 37.5954L3.54637 44.6621C3.31124 45.2286 3.39671 45.8812 3.76843 46.3636C4.08143 46.77 4.55495 47 5.04805 47C5.14113 47 5.23532 46.9922 5.32891 46.9748L16.4333 44.9822C18.6573 45.8016 21.0321 46.2164 23.5 46.2164C35.355 46.2164 45 36.2984 45 24.1082C45 11.9179 35.355 2 23.5 2Z"
                      fill="#53B1FF"
                      stroke="white"
                      stroke-width="4"
                    />
                    <path
                      d="M24.6312 17.7532L35.2399 28.0303C35.5873 28.367 35.5867 28.9122 35.2381 29.2483C34.8896 29.5842 34.3249 29.5833 33.9773 29.2466L24 19.5812L14.0227 29.2469C13.675 29.5836 13.1107 29.5845 12.7621 29.2487C12.5874 29.0801 12.5 28.8594 12.5 28.6386C12.5 28.4184 12.5868 28.1985 12.7603 28.0303L23.3688 17.7532C23.5358 17.591 23.7631 17.5 24 17.5C24.2368 17.5 24.4638 17.5913 24.6312 17.7532Z"
                      fill="#53B1FF"
                      stroke="white"
                      stroke-width="2"
                    />
                  </svg>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
        <div class="foot" *ngSwitchCase="viewEnum.HISTORY"></div>

        <div class="relative foot" *ngSwitchDefault>
          <!-- attr: autofocus -->
          <textarea
            matTooltipPosition="above"
            matTooltipClass="tooltip-above"
            [matTooltip]="'Type : to see templates' | translate"
            [formControl]="textAreaControl"
            #chatInput
            id="chatbox-textarea"
            (keyup.ArrowUp)="isSuggestionsShown && handleArrowUp()"
            matInput
            row="6"
            [placeholder]="'Write a reply...' | translate"
            (keydown.enter)="handleSuggestionMessage($event)"
            cdkTextareaAutosize
            [readonly]="this.chatController.PRIVATE_ONLY ? 'readonly' : ''"
          ></textarea>
          <div class="btns">
            <!-- NG_CONTENT: more-icon-->
            <div class="h-full left-btn">
              <!-- <ng-content select=".more-icon"  (click)="toggleChatBox()"></ng-content> -->
              <div class="more-icon" (click)="toggleChatBox()">
                <ng-container *ngIf="!chatBoxStatus">
                  <svg width="47" height="49" viewBox="0 0 47 49" fill="white" stroke="white" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M23.5 2C11.6451 2 2 11.9179 2 24.1082C2 26.8781 2.49531 29.5883 3.47449 32.1685C4.23546 34.1504 5.24352 35.971 6.47741 37.5954L3.54637 44.6621C3.31124 45.2286 3.39671 45.8812 3.76843 46.3636C4.08143 46.77 4.55495 47 5.04805 47C5.14113 47 5.23532 46.9922 5.32891 46.9748L16.4333 44.9822C18.6573 45.8016 21.0321 46.2164 23.5 46.2164C35.355 46.2164 45 36.2984 45 24.1082C45 11.9179 35.355 2 23.5 2Z"
                      fill="#53B1FF"
                      stroke="white"
                      stroke-width="4"
                    />
                    <path
                      d="M23.3688 31.2468L12.7601 20.9697C12.4127 20.633 12.4133 20.0878 12.7619 19.7517C13.1104 19.4158 13.6751 19.4167 14.0227 19.7534L24 29.4188L33.9773 19.7531C34.325 19.4164 34.8893 19.4155 35.2379 19.7513C35.4126 19.9199 35.5 20.1406 35.5 20.3614C35.5 20.5816 35.4132 20.8015 35.2397 20.9697L24.6312 31.2468C24.4642 31.409 24.2369 31.5 24 31.5C23.7632 31.5 23.5362 31.4087 23.3688 31.2468Z"
                      fill="#53B1FF"
                      stroke="white"
                      stroke-width="2"
                    />
                  </svg>
                </ng-container>
                <ng-container *ngIf="chatBoxStatus">
                  <svg width="47" height="49" viewBox="0 0 47 49" fill="white" stroke="white" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M23.5 2C11.6451 2 2 11.9179 2 24.1082C2 26.8781 2.49531 29.5883 3.47449 32.1685C4.23546 34.1504 5.24352 35.971 6.47741 37.5954L3.54637 44.6621C3.31124 45.2286 3.39671 45.8812 3.76843 46.3636C4.08143 46.77 4.55495 47 5.04805 47C5.14113 47 5.23532 46.9922 5.32891 46.9748L16.4333 44.9822C18.6573 45.8016 21.0321 46.2164 23.5 46.2164C35.355 46.2164 45 36.2984 45 24.1082C45 11.9179 35.355 2 23.5 2Z"
                      fill="#53B1FF"
                      stroke="white"
                      stroke-width="4"
                    />
                    <path
                      d="M24.6312 17.7532L35.2399 28.0303C35.5873 28.367 35.5867 28.9122 35.2381 29.2483C34.8896 29.5842 34.3249 29.5833 33.9773 29.2466L24 19.5812L14.0227 29.2469C13.675 29.5836 13.1107 29.5845 12.7621 29.2487C12.5874 29.0801 12.5 28.8594 12.5 28.6386C12.5 28.4184 12.5868 28.1985 12.7603 28.0303L23.3688 17.7532C23.5358 17.591 23.7631 17.5 24 17.5C24.2368 17.5 24.4638 17.5913 24.6312 17.7532Z"
                      fill="#53B1FF"
                      stroke="white"
                      stroke-width="2"
                    />
                  </svg>
                </ng-container>
              </div>
              <!-- NG_CONTENT: more-icon-->
              <!-- Tags -->
              <button
                id="chatbox-add-tag"
                class="flex items-center chat-btn tab-btn px-15"
                (click)="openTagDialog()"
                matTooltipPosition="above"
                matTooltipClass="tooltip-above"
                [matTooltip]="'Tags' | translate"
              >
                <reactor-room-svg [name]="'chat_tag'" [fill]="'white'"></reactor-room-svg>
              </button>
            </div>
            <div class="button-group">
              <!-- Presets -->
              <button
                id="chatbox-preset-and-template"
                class="flex items-center chat-btn px-15"
                (click)="chatboxConfig.openPresetsDialog(isFormHide, isProductHide, isProductCatalogHide)"
                matTooltipPosition="above"
                matTooltipClass="tooltip-above"
                [matTooltip]="'Presets and templates' | translate"
              >
                <reactor-room-svg [name]="'preset_template'" [fill]="'white'"></reactor-room-svg>
              </button>

              <!-- Images -->
              <button
                class="flex items-center chat-btn px-15"
                (click)="selectImages.click()"
                matTooltipPosition="above"
                matTooltipClass="tooltip-above"
                [matTooltip]="'Add images' | translate"
              >
                <reactor-room-svg [name]="'chat_select_images'" [fill]="'white'"></reactor-room-svg>
                <input
                  style="display: none"
                  #selectImages
                  type="file"
                  id="chatbox-image-file"
                  multiple
                  accept="image/*"
                  (change)="imageUpload(audience, $event?.target?.files, audience.id, userSender, selectImages)"
                />
              </button>

              <!-- Attachments -->
              <button
                class="flex items-center chat-btn px-15"
                (click)="selectFiles.click()"
                matTooltipPosition="above"
                matTooltipClass="tooltip-above"
                [matTooltip]="'Add files' | translate"
              >
                <reactor-room-svg [name]="'chat_select_attachments'" [fill]="'white'"></reactor-room-svg>
                <input
                  style="display: none"
                  #selectFiles
                  type="file"
                  id="chatbox-attachment-file"
                  accept=".pdf,.doc,.docx,.txt,.csv,.xml"
                  (change)="fileUpload(audience, $event?.target?.files, audience.id, userSender, selectFiles)"
                />
              </button>

              <!-- Send -->
              <button
                id="chatbox-send-button"
                class="flex items-center chat-btn btn-send"
                (click)="handleSuggestionMessage($event)"
                matTooltipPosition="above"
                matTooltipClass="tooltip-above"
                [matTooltip]="'Send' | translate"
              >
                <reactor-room-svg [name]="'chat_send'" [fill]="'#54B1FF'"></reactor-room-svg>
              </button>
            </div>
          </div>
        </div>
      </ng-container>
    </ng-container>
  </div>

  <div class="button-toogle-group">
    <ng-container class="button-group-control">
      <div class="button-groups" *ngIf="buttonGroupStatus" (click)="deactiveButtonGroup()"></div>
      <div class="button-box" [@slideBox]="buttonGroupStatus ? 'active' : 'inactive'">
        <ng-content></ng-content>
        <div class="seperate"></div>
        <div class="btn-item cancel" (click)="deactiveButtonGroup()">
          <span>{{ 'Close' | translate }}</span>
        </div>
      </div>
    </ng-container>
  </div>
</section>
